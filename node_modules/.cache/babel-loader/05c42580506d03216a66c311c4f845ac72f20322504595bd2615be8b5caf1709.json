{"ast":null,"code":"var is = require('type-is');\nvar Busboy = require('busboy');\nvar extend = require('xtend');\nvar appendField = require('append-field');\nvar Counter = require('./counter');\nvar MulterError = require('./multer-error');\nvar FileAppender = require('./file-appender');\nvar removeUploadedFiles = require('./remove-uploaded-files');\nfunction makeMiddleware(setup) {\n  return function multerMiddleware(req, res, next) {\n    if (!is(req, ['multipart'])) return next();\n    var options = setup();\n    var limits = options.limits;\n    var storage = options.storage;\n    var fileFilter = options.fileFilter;\n    var fileStrategy = options.fileStrategy;\n    var preservePath = options.preservePath;\n    req.body = Object.create(null);\n    var busboy;\n    try {\n      busboy = Busboy({\n        headers: req.headers,\n        limits: limits,\n        preservePath: preservePath\n      });\n    } catch (err) {\n      return next(err);\n    }\n    var appender = new FileAppender(fileStrategy, req);\n    var isDone = false;\n    var readFinished = false;\n    var errorOccured = false;\n    var pendingWrites = new Counter();\n    var uploadedFiles = [];\n    function done(err) {\n      if (isDone) return;\n      isDone = true;\n      req.unpipe(busboy);\n      busboy.removeAllListeners();\n      next(err);\n    }\n    function indicateDone() {\n      if (readFinished && pendingWrites.isZero() && !errorOccured) done();\n    }\n    function abortWithError(uploadError) {\n      if (errorOccured) return;\n      errorOccured = true;\n      pendingWrites.onceZero(function () {\n        function remove(file, cb) {\n          storage._removeFile(req, file, cb);\n        }\n        removeUploadedFiles(uploadedFiles, remove, function (err, storageErrors) {\n          if (err) return done(err);\n          uploadError.storageErrors = storageErrors;\n          done(uploadError);\n        });\n      });\n    }\n    function abortWithCode(code, optionalField) {\n      abortWithError(new MulterError(code, optionalField));\n    }\n\n    // handle text field data\n    busboy.on('field', function (fieldname, value, _ref) {\n      let {\n        nameTruncated,\n        valueTruncated\n      } = _ref;\n      if (fieldname == null) return abortWithCode('MISSING_FIELD_NAME');\n      if (nameTruncated) return abortWithCode('LIMIT_FIELD_KEY');\n      if (valueTruncated) return abortWithCode('LIMIT_FIELD_VALUE', fieldname);\n\n      // Work around bug in Busboy (https://github.com/mscdex/busboy/issues/6)\n      if (limits && Object.prototype.hasOwnProperty.call(limits, 'fieldNameSize')) {\n        if (fieldname.length > limits.fieldNameSize) return abortWithCode('LIMIT_FIELD_KEY');\n      }\n      appendField(req.body, fieldname, value);\n    });\n\n    // handle files\n    busboy.on('file', function (fieldname, fileStream, _ref2) {\n      let {\n        filename,\n        encoding,\n        mimeType\n      } = _ref2;\n      // don't attach to the files object, if there is no file\n      if (!filename) return fileStream.resume();\n\n      // Work around bug in Busboy (https://github.com/mscdex/busboy/issues/6)\n      if (limits && Object.prototype.hasOwnProperty.call(limits, 'fieldNameSize')) {\n        if (fieldname.length > limits.fieldNameSize) return abortWithCode('LIMIT_FIELD_KEY');\n      }\n      var file = {\n        fieldname: fieldname,\n        originalname: filename,\n        encoding: encoding,\n        mimetype: mimeType\n      };\n      var placeholder = appender.insertPlaceholder(file);\n      fileFilter(req, file, function (err, includeFile) {\n        if (err) {\n          appender.removePlaceholder(placeholder);\n          return abortWithError(err);\n        }\n        if (!includeFile) {\n          appender.removePlaceholder(placeholder);\n          return fileStream.resume();\n        }\n        var aborting = false;\n        pendingWrites.increment();\n        Object.defineProperty(file, 'stream', {\n          configurable: true,\n          enumerable: false,\n          value: fileStream\n        });\n        fileStream.on('error', function (err) {\n          pendingWrites.decrement();\n          abortWithError(err);\n        });\n        fileStream.on('limit', function () {\n          aborting = true;\n          abortWithCode('LIMIT_FILE_SIZE', fieldname);\n        });\n        storage._handleFile(req, file, function (err, info) {\n          if (aborting) {\n            appender.removePlaceholder(placeholder);\n            uploadedFiles.push(extend(file, info));\n            return pendingWrites.decrement();\n          }\n          if (err) {\n            appender.removePlaceholder(placeholder);\n            pendingWrites.decrement();\n            return abortWithError(err);\n          }\n          var fileInfo = extend(file, info);\n          appender.replacePlaceholder(placeholder, fileInfo);\n          uploadedFiles.push(fileInfo);\n          pendingWrites.decrement();\n          indicateDone();\n        });\n      });\n    });\n    busboy.on('error', function (err) {\n      abortWithError(err);\n    });\n    busboy.on('partsLimit', function () {\n      abortWithCode('LIMIT_PART_COUNT');\n    });\n    busboy.on('filesLimit', function () {\n      abortWithCode('LIMIT_FILE_COUNT');\n    });\n    busboy.on('fieldsLimit', function () {\n      abortWithCode('LIMIT_FIELD_COUNT');\n    });\n    busboy.on('close', function () {\n      readFinished = true;\n      indicateDone();\n    });\n    req.pipe(busboy);\n  };\n}\nmodule.exports = makeMiddleware;","map":{"version":3,"names":["is","require","Busboy","extend","appendField","Counter","MulterError","FileAppender","removeUploadedFiles","makeMiddleware","setup","multerMiddleware","req","res","next","options","limits","storage","fileFilter","fileStrategy","preservePath","body","Object","create","busboy","headers","err","appender","isDone","readFinished","errorOccured","pendingWrites","uploadedFiles","done","unpipe","removeAllListeners","indicateDone","isZero","abortWithError","uploadError","onceZero","remove","file","cb","_removeFile","storageErrors","abortWithCode","code","optionalField","on","fieldname","value","_ref","nameTruncated","valueTruncated","prototype","hasOwnProperty","call","length","fieldNameSize","fileStream","_ref2","filename","encoding","mimeType","resume","originalname","mimetype","placeholder","insertPlaceholder","includeFile","removePlaceholder","aborting","increment","defineProperty","configurable","enumerable","decrement","_handleFile","info","push","fileInfo","replacePlaceholder","pipe","module","exports"],"sources":["/Users/user/schoolbook-fe/node_modules/multer/lib/make-middleware.js"],"sourcesContent":["var is = require('type-is')\nvar Busboy = require('busboy')\nvar extend = require('xtend')\nvar appendField = require('append-field')\n\nvar Counter = require('./counter')\nvar MulterError = require('./multer-error')\nvar FileAppender = require('./file-appender')\nvar removeUploadedFiles = require('./remove-uploaded-files')\n\nfunction makeMiddleware (setup) {\n  return function multerMiddleware (req, res, next) {\n    if (!is(req, ['multipart'])) return next()\n\n    var options = setup()\n\n    var limits = options.limits\n    var storage = options.storage\n    var fileFilter = options.fileFilter\n    var fileStrategy = options.fileStrategy\n    var preservePath = options.preservePath\n\n    req.body = Object.create(null)\n\n    var busboy\n\n    try {\n      busboy = Busboy({ headers: req.headers, limits: limits, preservePath: preservePath })\n    } catch (err) {\n      return next(err)\n    }\n\n    var appender = new FileAppender(fileStrategy, req)\n    var isDone = false\n    var readFinished = false\n    var errorOccured = false\n    var pendingWrites = new Counter()\n    var uploadedFiles = []\n\n    function done (err) {\n      if (isDone) return\n      isDone = true\n      req.unpipe(busboy)\n      busboy.removeAllListeners()\n      next(err)\n    }\n\n    function indicateDone () {\n      if (readFinished && pendingWrites.isZero() && !errorOccured) done()\n    }\n\n    function abortWithError (uploadError) {\n      if (errorOccured) return\n      errorOccured = true\n\n      pendingWrites.onceZero(function () {\n        function remove (file, cb) {\n          storage._removeFile(req, file, cb)\n        }\n\n        removeUploadedFiles(uploadedFiles, remove, function (err, storageErrors) {\n          if (err) return done(err)\n\n          uploadError.storageErrors = storageErrors\n          done(uploadError)\n        })\n      })\n    }\n\n    function abortWithCode (code, optionalField) {\n      abortWithError(new MulterError(code, optionalField))\n    }\n\n    // handle text field data\n    busboy.on('field', function (fieldname, value, { nameTruncated, valueTruncated }) {\n      if (fieldname == null) return abortWithCode('MISSING_FIELD_NAME')\n      if (nameTruncated) return abortWithCode('LIMIT_FIELD_KEY')\n      if (valueTruncated) return abortWithCode('LIMIT_FIELD_VALUE', fieldname)\n\n      // Work around bug in Busboy (https://github.com/mscdex/busboy/issues/6)\n      if (limits && Object.prototype.hasOwnProperty.call(limits, 'fieldNameSize')) {\n        if (fieldname.length > limits.fieldNameSize) return abortWithCode('LIMIT_FIELD_KEY')\n      }\n\n      appendField(req.body, fieldname, value)\n    })\n\n    // handle files\n    busboy.on('file', function (fieldname, fileStream, { filename, encoding, mimeType }) {\n      // don't attach to the files object, if there is no file\n      if (!filename) return fileStream.resume()\n\n      // Work around bug in Busboy (https://github.com/mscdex/busboy/issues/6)\n      if (limits && Object.prototype.hasOwnProperty.call(limits, 'fieldNameSize')) {\n        if (fieldname.length > limits.fieldNameSize) return abortWithCode('LIMIT_FIELD_KEY')\n      }\n\n      var file = {\n        fieldname: fieldname,\n        originalname: filename,\n        encoding: encoding,\n        mimetype: mimeType\n      }\n\n      var placeholder = appender.insertPlaceholder(file)\n\n      fileFilter(req, file, function (err, includeFile) {\n        if (err) {\n          appender.removePlaceholder(placeholder)\n          return abortWithError(err)\n        }\n\n        if (!includeFile) {\n          appender.removePlaceholder(placeholder)\n          return fileStream.resume()\n        }\n\n        var aborting = false\n        pendingWrites.increment()\n\n        Object.defineProperty(file, 'stream', {\n          configurable: true,\n          enumerable: false,\n          value: fileStream\n        })\n\n        fileStream.on('error', function (err) {\n          pendingWrites.decrement()\n          abortWithError(err)\n        })\n\n        fileStream.on('limit', function () {\n          aborting = true\n          abortWithCode('LIMIT_FILE_SIZE', fieldname)\n        })\n\n        storage._handleFile(req, file, function (err, info) {\n          if (aborting) {\n            appender.removePlaceholder(placeholder)\n            uploadedFiles.push(extend(file, info))\n            return pendingWrites.decrement()\n          }\n\n          if (err) {\n            appender.removePlaceholder(placeholder)\n            pendingWrites.decrement()\n            return abortWithError(err)\n          }\n\n          var fileInfo = extend(file, info)\n\n          appender.replacePlaceholder(placeholder, fileInfo)\n          uploadedFiles.push(fileInfo)\n          pendingWrites.decrement()\n          indicateDone()\n        })\n      })\n    })\n\n    busboy.on('error', function (err) { abortWithError(err) })\n    busboy.on('partsLimit', function () { abortWithCode('LIMIT_PART_COUNT') })\n    busboy.on('filesLimit', function () { abortWithCode('LIMIT_FILE_COUNT') })\n    busboy.on('fieldsLimit', function () { abortWithCode('LIMIT_FIELD_COUNT') })\n    busboy.on('close', function () {\n      readFinished = true\n      indicateDone()\n    })\n\n    req.pipe(busboy)\n  }\n}\n\nmodule.exports = makeMiddleware\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}